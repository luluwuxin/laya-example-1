var url=require("url"),http=require("http"),socket=require("ws"),express=require("express"),utils=require("./Utils.js"),LogicServer=require("./Server.js").LogicServer,app=express();app.use(express.static("web"));var server=http.createServer(app),wss=new socket.Server({server:server}),ccc=null,logic=new LogicServer;
wss.on("connection",function(a,b){url.parse(b.url,!0);a.remoteAddress=(b.headers["x-forwarded-for"]||b.connection.remoteAddress||b.socket.remoteAddress||b.connection.socket.remoteAddress).split(":")[3];a.on("close",function(d,b){var c=logic.isAuth(a)?"auth":"unauth";console.log("!losed! "+c+' client %s disconnect: code=%d, reason="%s"',a.remoteAddress,d,b);logic.removeSocket(a)});a.on("error",function(a){console.log("error:"+a)});a.on("message",function(b){var c=JSON.parse(b);0==logic.isAuth(a)?"auth"==
c.method?logic.procAuth(a,c):(console.log("%s !!unauth!! message:%s",a.remoteAddress,b),a.send(b)):logic.procMessage(a,c)});console.log("!new! unauth connect:%s!",a.remoteAddress)});server.listen(8081,function(){console.log("Listening on %d",server.address().port)});
