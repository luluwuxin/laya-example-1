var LoadedDataManagerEvent={MAP_DATA_LOADED:"map data loaded",CASE_DATA_START_LOAD:"case data start load",CASE_DATA_LOADED:"case data loaded",DATA_DIRTY_CHANGED:"data dirty changed"};class LoadedDataManager extends EventObject{constructor(t,a){super(),this._obstacleManager=t,this._user=a,this._dataDirtyFlag=!1,this.mapData=null,this.caseFilePath="",this._obstacleManager.registerEvent(ObstacleManagerEvent.ADDED,this,this._onObstacleAdded),this._obstacleManager.registerEvent(ObstacleManagerEvent.REMOVED,this,this._onDataChanged);var e=this._obstacleManager.getMainCar();this._listenSceneObjectChange(e),this._listenRoutePointChange(e.startPoint)}_onRoutePointAdded(t,a){this._listenRoutePointChange(a),this._onDataChanged()}_onObstacleAdded(t,a){this._listenSceneObjectChange(a),this._onDataChanged()}_onDataChanged(){this.setDataDirty(!0)}_listenSceneObjectChange(t){t.registerEvent(ObjectEvent.VALUE_CHANGED,this,this._onDataChanged),t.registerEvent(SceneObjectEvent.ROUTE_POINT_ADDED,this,this._onRoutePointAdded),t.registerEvent(SceneObjectEvent.ROUTE_POINT_REMOVED,this,this._onDataChanged)}_listenRoutePointChange(t){t.registerEvent(ObjectEvent.VALUE_CHANGED,this,this._onDataChanged)}loadMapDataByMapName(t){var a=AssetsPath.getMapConfigFilePath(t);FileHelper.readFile(a,this,function(e){""==e?logError("Load map faile. Path: [{0}]".format(a)):this.loadMapData(t,e)})}loadMapData(t,a){var e=JSON.parse(a);this.mapData=new MapData(e,t),this.sendEvent(LoadedDataManagerEvent.MAP_DATA_LOADED,this.mapData)}loadCase(t,a=!0){this.loadCaseByJsonObject(JSON.parse(t),a)}loadCaseByJsonObject(t,a){this.sendEvent(LoadedDataManagerEvent.CASE_DATA_START_LOAD),this._user.clear(),this._obstacleManager.clear();var e=t.obstacles,n=null,s=null;for(var i of e){var r=new Obstacle(i.type,i.name);null==n&&(n=r),this._obstacleManager.addObstacle(r),this._listenSceneObjectChange(r);var o=i.moveStates;for(var l of o){var h=new Pose(Quat.fromJson(l.quat),Vec3.fromJson(l.tran)),D=r.createRoutePoint(null,h,l.is_reversing,l.timestamp_interval,l.speed,l.lock_type);r.addRoutePoint(D),this._listenRoutePointChange(D),r==n&&null==s&&(s=D)}}var d=t.mainCar,_=this._obstacleManager.getMainCar();for(var g of(_.setValue("timeLimit",d.timeLimit),_.startPoint.fromJson(d.startPoint),d.route)){D=_.createRoutePoint(null,new Pose(null,Vec3.fromJson(g)));_.addRoutePoint(D)}a&&this.setDataDirty(!1),this.sendEvent(LoadedDataManagerEvent.CASE_DATA_LOADED),null!=n&&this._user.selectObstacle(n),null!=s&&this._user.selectRoutePoint(s)}downloadCaseData(){FileHelper.createAndDownloadFile("case.json",this.getCaseDataJsonString())}getMapDataJsonString(){return JSON.stringify(this.mapData.mapDataJson)}getCaseDataJsonString(){var t=this._obstacleManager.toJson();return JSON.stringify(t)}setDataDirty(t){this._dataDirtyFlag!=t&&(this._dataDirtyFlag=t,this.sendEvent(LoadedDataManagerEvent.DATA_DIRTY_CHANGED,this._dataDirtyFlag))}onDataSaved(){this.setDataDirty(!1)}hasUnsavedData(){return this._dataDirtyFlag}}