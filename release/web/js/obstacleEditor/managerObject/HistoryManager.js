var HistoryManager=function(){class t{constructor(t){this.jsonObj=t,this.timestamp=Date.now()}canMerge(t){return t.timestamp-this.timestamp<50}}function e(){if(0!=this._historyEnabled){var e=this._historyList.length,s=new t(this._obstacleManager.toJson());this._historyList.splice(this._currentIndex+1,e-1-this._currentIndex),this._currentIndex>=0&&this._historyList[this._currentIndex].canMerge(s)&&(this._historyList.splice(this._currentIndex,1),this._currentIndex-=1),this._historyList.push(s),this._currentIndex+=1}else this._historyDirty=!0}function s(){this._loadedDataManager.loadCaseByJsonObject(this._historyList[this._currentIndex].jsonObj,!1)}function i(t,s){s.registerEvent(ObjectEvent.VALUE_CHANGED,this,r),s.registerEvent(ObstacleEvent.ROUTE_POINT_ADDED,this,o),s.registerEvent(ObstacleEvent.ROUTE_POINT_REMOVED,this,a),e.call(this)}function n(t,s){e.call(this)}function r(t,s,i){e.call(this)}function o(t,s){s.registerEvent(ObjectEvent.VALUE_CHANGED,this,h),e.call(this)}function a(t,s){e.call(this)}function h(t,s,i){e.call(this)}function c(t){this._isDoMode||this.disableRecordHistory()}function l(t){this._isDoMode||this.enableRecordHistory()}function _(t){this._isDoMode=t,t?this.disableRecordHistory():this.enableRecordHistory(!1)}function d(){this._saveInfo={};var t=this._user.getSelectedObstacle();this._saveInfo.obstacleIndex=this._obstacleManager.getObstacleIndex(t);var e=this._user.getSelectedRoutePoint();this._saveInfo.routePointIndex=null==e?-1:e.index}function E(){var t=null;-1!=this._saveInfo.obstacleIndex&&(t=this._obstacleManager.getObstacle(this._saveInfo.obstacleIndex),this._user.selectObstacle(t)),-1!=this._saveInfo.routePointIndex&&null!=t&&this._user.selectRoutePoint(t.getRoutePoint(this._saveInfo.routePointIndex))}return class{constructor(t,s,_){this._historyList=[],this._currentIndex=-1,this._historyEnabled=!0,this._historyDirty=!1,this._isDoMode=!1,this._obstacleManager=t,this._loadedDataManager=s,this._user=_,s.registerEvent(LoadedDataManagerEvent.CASE_DATA_START_LOAD,this,c),s.registerEvent(LoadedDataManagerEvent.CASE_DATA_LOADED,this,l),t.registerEvent(ObstacleManagerEvent.ADDED,this,i),t.registerEvent(ObstacleManagerEvent.REMOVED,this,n);var d=t.getObstacles();for(var E of d){E.registerEvent(ObjectEvent.VALUE_CHANGED,this,r),E.registerEvent(ObstacleEvent.ROUTE_POINT_ADDED,this,o),E.registerEvent(ObstacleEvent.ROUTE_POINT_REMOVED,this,a);var u=E.getRoutePoints();for(var b of u)b.registerEvent(ObjectEvent.VALUE_CHANGED,this,h)}e.call(this)}disableRecordHistory(){if(0==this._historyEnabled)return logError("Logic error, there shall be no action to disable record when it's already disabled."),void console.trace();this._historyEnabled=!1,this._historyDirty=!1}enableRecordHistory(t=!0){if(this._historyEnabled)return logError("Logic error, there shall be no action to enable record when it's already enabled."),void console.trace();this._historyEnabled=!0,t&&this._historyDirty&&(e.call(this),this._historyDirty=!1)}canUndo(){return this._currentIndex>0}canRedo(){return this._currentIndex+1<this._historyList.length}undo(){0!=this.canUndo()&&(d.call(this),_.call(this,!0),this._currentIndex-=1,s.call(this),_.call(this,!1),E.call(this))}redo(){0!=this.canRedo()&&(d.call(this),_.call(this,!0),this._currentIndex+=1,s.call(this),_.call(this,!1),E.call(this))}}}();