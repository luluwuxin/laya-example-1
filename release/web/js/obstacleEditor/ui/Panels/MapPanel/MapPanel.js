class ObstacleUIOnMap{constructor(t,e,i){DependencesHelper.setDependencesByParent(this,t,"mapPanelScript"),this._container=i;var n=function(){var t=new laya.ui.Box;return t.left=0,t.right=0,t.top=0,t.bottom=0,t.mouseThrough=!0,t};this.obstacleContainer=n(),this._container.addChild(this.obstacleContainer),this.routePointLinkLineContainer=n(),this.obstacleContainer.addChild(this.routePointLinkLineContainer),this.routePointContainer=n(),this.obstacleContainer.addChild(this.routePointContainer),this.routePointViews=[],this.routePointLinkLineViews=[],this.highlight(!1)}destroy(){this.obstacleContainer.destroy(),this.obstacleContainer=null}setSelected(t){this.highlight(t),t&&this._container.setChildIndex(this.obstacleContainer,this._container.numChildren-1)}highlight(t){this.obstacleContainer.alpha=t?1:.3}addRoutePoint(t){var e=t.index,i=new RoutePointViewScript(this,t);this.routePointContainer.addChild(i),this.routePointViews.splice(e,0,i),i.update();var n=new RoutePointLinkLineView(this,t,this.routePointLinkLineContainer);this.routePointLinkLineViews.splice(e,0,n)}removeRoutePoint(t){var e=t.index;this.routePointViews[e].destroy(),this.routePointViews.splice(e,1),this.routePointLinkLineViews[e].destroy(),this.routePointLinkLineViews.splice(e,1)}}class MainCarUIOnMap extends ObstacleUIOnMap{constructor(t,e,i){super(t,e,i);var n=new RoutePointViewScript(this,e.startPoint);this.routePointContainer.addChild(n)}addRoutePoint(t){var e=t.index,i=new RoutePointViewScript(this,t);this.routePointContainer.addChild(i),this.routePointViews.splice(e,0,i),i.update();var n=new MainCarRoutePointLinkLineView(this,t,this.routePointLinkLineContainer);this.routePointLinkLineViews.splice(e,0,n)}}class MiniMap{constructor(t){DependencesHelper.setDependencesByParent(this,t,"mapPanel"),this._loadedDataManager.registerEvent(LoadedDataManagerEvent.MAP_DATA_LOADED,this,this.onMapDataLoaded)}_miniMapFollowMouse(t){var e=this._mapPanel.miniMapBox.width/this._mapData.mapInfo.width,i=this._mapPanel.miniMapButton.mouseX/e,n=this._mapPanel.miniMapButton.mouseY/e;this._mapPanel.putPointToMapCenter(i,n)}onMiniMapButtonCancel(t){this._mapPanel.miniMapButton.off(Event.MOUSE_MOVE,this,this.onMiniMapButtonMove)}onMiniMapButtonMove(t){this._miniMapFollowMouse(t)}onMiniMapButtonDown(t){this._mapPanel.miniMapButton.on(Event.MOUSE_MOVE,this,this.onMiniMapButtonMove),this._miniMapFollowMouse(t)}init(t){this._mapData=t,this._mapPanel.miniMapButton.on(Event.MOUSE_DOWN,this,this.onMiniMapButtonDown),this._mapPanel.miniMapButton.on(Event.MOUSE_UP,this,this.onMiniMapButtonCancel),this._mapPanel.miniMapButton.on(Event.MOUSE_OUT,this,this.onMiniMapButtonCancel);var e=300,i=200,n=t.mapInfo;e/i<n.width/n.height?i=n.height/n.width*e:e=n.width/n.height*i,this._mapPanel.miniMapBox.width=e,this._mapPanel.miniMapBox.height=i,this._mapPanel.miniMapImage.skin=t.getMapImagePath(),this._mapPanel.miniMapImageLight.skin=t.getMapImagePath(),this._refreshMiniMapFrame()}_refreshMiniMapFrame(){var t=this._mapPanel.mainContainer.hScrollBar.value,e=this._mapPanel.mainContainer.vScrollBar.value,i=this._mapPanel.miniMapBox.width/this._mapData.mapInfo.width;this._mapPanel.actualFrame.width=this._mapPanel.mainContainer.width*i,this._mapPanel.actualFrame.height=this._mapPanel.mainContainer.height*i,this._mapPanel.actualFrame.x=t*i,this._mapPanel.actualFrame.y=e*i}onMapDataLoaded(t,e){this.init(e)}}function MapPanelScript(t){function e(t,e,i){this._addSceneObject(e)}function i(t,e,i){this._removeSceneObject(e)}function n(t,e){this.addRoutePoint(e)}function a(t,e){this.removeRoutePoint(e)}function o(t,e,i){this.selectSceneObject(e,i)}function s(){this._miniMap._refreshMiniMapFrame()}function h(){this._isMainContainerClick=!0,this.mainContainer.on(Event.MOUSE_MOVE,this,c),this.mainContainer.on(Event.MOUSE_OUT,this,c)}function r(){this._isMainContainerClick&&function(){var t=this._user.getSelectedSceneObject();if(null==t)return;var e=this._mapData.uiToMapPosition({x:this.mapImage.mouseX,y:this.mapImage.mouseY}),i=null,n=new Pose;n.vec3.x=e.x,n.vec3.y=e.y;var a=this._user.getSelectedRoutePoint();if(null!=a&&a.pointType==ObjectPointType.MAIN_CAR_START_POINT)t.startPoint.setValue("x",e.x,"y",e.y,"z",this._mapData.mapInfo.objectZ);else{if(0==t.getRoutePointCount())i=t.createRoutePoint(this._mapData,n),t.addRoutePoint(i);else if(null==a){var o=t.getRoutePoint(t.getRoutePointCount()-1);(i=o.clone()).x=n.vec3.x,i.y=n.vec3.y,t.addRoutePoint(i)}else{var s=a.index;(i=a.clone()).x=n.vec3.x,i.y=n.vec3.y,t.addRoutePoint(i,s+1)}this._user.selectRoutePoint(i)}}.call(this)}function c(){this._isMainContainerClick=!1,this.mainContainer.off(Event.MOUSE_MOVE,this,c),this.mainContainer.off(Event.MOUSE_OUT,this,c)}this.initEvent=function(){this._obstacleManager.registerEvent(ObstacleManagerEvent.ADDED,this,e),this._obstacleManager.registerEvent(ObstacleManagerEvent.REMOVED,this,i),this._user.registerEvent(UserEvent.SCENE_OBJECT_SELECTED,this,o),this.mainContainer.vScrollBar.on(Event.CHANGE,this,s),this.mainContainer.hScrollBar.on(Event.CHANGE,this,s),this.mainContainer.on(Event.MOUSE_DOWN,this,h),this.mainContainer.on(Event.MOUSE_UP,this,r)},this.getViewCenter=function(){var t=this.mainContainer.hScrollBar.value,e=this.mainContainer.vScrollBar.value;return{x:t+=this.mainContainer.width/2,y:e+=this.mainContainer.height/2}},this.putPointToMapCenter=function(t,e){t=Math.max(0,t-this.mainContainer.width/2),e=Math.max(0,e-this.mainContainer.height/2),t=Math.min(t,this._mapData.mapInfo.width-this.mainContainer.width),e=Math.min(e,this._mapData.mapInfo.height-this.mainContainer.height),this.mainContainer.scrollTo(t,e)},this.putRoutePointToMapCenter=function(t){var e=this._mapData.mapToUIPosition(t);this.putPointToMapCenter(e.x,e.y)},this._addSceneObject=function(t){var e=null;e=t.sceneObjectType==SceneObjectType.OBSTACLE?new ObstacleUIOnMap(this,t,this.mapImage):new MainCarUIOnMap(this,t,this.mapImage),this._sceneObjectRouteUIs[t.getUniqueID()]=e,t.registerEvent(ObstacleEvent.ROUTE_POINT_ADDED,this,n),t.registerEvent(ObstacleEvent.ROUTE_POINT_REMOVED,this,a)},this._removeSceneObject=function(t){this._sceneObjectRouteUIs[t.getUniqueID()].destroy(),delete this._sceneObjectRouteUIs[t.getUniqueID()]},this.addRoutePoint=function(t){var e=t.getOwner();this._sceneObjectRouteUIs[e.getUniqueID()].addRoutePoint(t)},this.removeRoutePoint=function(t){var e=t.getOwner();this._sceneObjectRouteUIs[e.getUniqueID()].removeRoutePoint(t)},this.selectSceneObject=function(t,e){null!=e&&e.getUniqueID()in this._sceneObjectRouteUIs&&this._sceneObjectRouteUIs[e.getUniqueID()].setSelected(!1),null!=t&&t.getUniqueID()in this._sceneObjectRouteUIs&&this._sceneObjectRouteUIs[t.getUniqueID()].setSelected(!0)},this.setMapData=function(t){logInfo("Set map data. map image path = [{0}]".format(t.getMapImagePath())),this._mapData=t,this.mapImage.skin=this._mapData.getMapImagePath(),this.mapImage.height=this._mapData.mapInfo.height,this.mapImage.width=this._mapData.mapInfo.width,this.initObstacleInfo()},this.initObstacleInfo=function(){for(var t=this._obstacleManager.getObstacles(),e=0;e<t.length;e++){this._addSceneObject(t[e]);for(var i=t[e].getRoutePoints(),n=0;n<i.length;n++)this.addRoutePoint(i[n])}},MapPanelScript.super(this),DependencesHelper.setDependences(this,t),this._sceneObjectRouteUIs={},this._miniMap=new MiniMap(this),this._loadedDataManager.registerEvent(LoadedDataManagerEvent.MAP_DATA_LOADED,this,function(t,e){this.setMapData(e),this.initEvent()}),ObjectHelper.swallowScrollMouseDown(this.mainContainer.hScrollBar),ObjectHelper.swallowScrollMouseDown(this.mainContainer.vScrollBar),this._addSceneObject(this._obstacleManager.getMainCar())}Laya.class(MapPanelScript,"MapPanelScript",MapPanelUI);